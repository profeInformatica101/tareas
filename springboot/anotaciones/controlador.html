<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçÉ Thymeleaf + Spring MVC (Controladores)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome (como en tu plantilla) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; }
    h1 { color: #28a745; }

    pre {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      padding: 12px;
      border-radius: 10px;
      overflow: auto;
      margin: 10px 0 16px;
    }
    code { color: darkred; }

    .callout {
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 12px 14px;
      background: #fff;
      margin: 10px 0 16px;
    }
    .callout .title { font-weight: 700; }
    .callout.tip { border-left: 6px solid #0d6efd; }
    .callout.warn { border-left: 6px solid #ffc107; }
    .callout.good { border-left: 6px solid #28a745; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      font-size: .82rem;
      padding: .25rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      margin-right: .35rem;
      margin-bottom: .35rem;
    }
  </style>
</head>

<body>
<div class="container mt-5">
  <h1><i class="fas fa-leaf"></i> Spring MVC + Thymeleaf: Anotaciones clave en Controladores</h1>
  <p class="text-muted mb-3">
    En MVC con Thymeleaf, el controlador <strong>devuelve el nombre de una vista</strong> con <code>return "nombre-vista"</code>
    y Spring busca <code>nombre-vista.html</code> en <strong>resources/templates</strong>.
  </p>

  <div class="callout good">
    <div class="title"><i class="fas fa-check-circle me-2"></i>‚úÖ Idea esencial (MVC)</div>
    <div>
      Un controlador MVC normalmente devuelve:
      <ul class="mb-0">
        <li><strong>Una vista</strong>: <code>return "productos/lista"</code></li>
        <li>Y opcionalmente <strong>datos</strong> para la vista en el <code>Model</code>: <code>model.addAttribute("productos", ...)</code></li>
      </ul>
    </div>
  </div>

  <div class="callout tip">
    <div class="title"><i class="fas fa-lightbulb me-2"></i>üí° Cu√°ndo NO usar @RestController</div>
    <div>
      Si est√°s renderizando HTML con Thymeleaf, usa <code>@Controller</code>.
      <code>@RestController</code> es para devolver JSON (APIs REST).
    </div>
  </div>

  <div class="accordion" id="thymeleafAccordion">

    <!-- 0) @Controller, Model y nombre de vista -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingBase">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBase" aria-expanded="true" aria-controls="collapseBase">
          <i class="fas fa-door-open me-2"></i> Base: @Controller, Model y return "nombre-vista"
        </button>
      </h2>

      <div id="collapseBase" class="accordion-collapse collapse show" aria-labelledby="headingBase" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <span class="pill"><i class="fas fa-layer-group"></i> MVC</span>
          <span class="pill"><i class="fas fa-file-alt"></i> templates/</span>
          <span class="pill"><i class="fas fa-database"></i> Model</span>

          <p class="mb-2"><strong>Prop√≥sito:</strong> indicar que la clase maneja rutas web y devuelve vistas HTML.</p>
          <p class="mb-2"><strong>Cu√°ndo y por qu√© usarlo:</strong> cuando quieres renderizar p√°ginas con Thymeleaf.</p>

          <pre><code>// templates/home.html
// templates/productos/lista.html

@Controller
public class HomeController {

  @GetMapping("/")
  public String home() {
    // Devuelve "home" ‚Üí Spring buscar√° templates/home.html
    return "home";
  }

  @GetMapping("/productos")
  public String lista(Model model) {
    // A√±ades datos a la vista
    model.addAttribute("titulo", "Listado de productos");
    model.addAttribute("productos", List.of("Teclado", "Rat√≥n", "Monitor"));

    // Devuelve "productos/lista" ‚Üí templates/productos/lista.html
    return "productos/lista";
  }
}</code></pre>

          <div class="callout warn">
            <div class="title"><i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Error t√≠pico</div>
            <div>
              Devolver <code>return "/productos/lista.html"</code> o rutas con extensi√≥n suele romper convenciones.
              Lo habitual es devolver <strong>solo el nombre l√≥gico</strong>: <code>return "productos/lista"</code>.
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- 1) @RequestMapping + @GetMapping/@PostMapping en MVC -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingRouting">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRouting" aria-expanded="false" aria-controls="collapseRouting">
          <i class="fas fa-route me-2"></i> Rutas: @RequestMapping, @GetMapping, @PostMapping, @PutMapping, @DeleteMapping
        </button>
      </h2>

      <div id="collapseRouting" class="accordion-collapse collapse" aria-labelledby="headingRouting" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <p class="mb-2"><strong>Prop√≥sito:</strong> mapear URL + m√©todo HTTP a m√©todos del controlador.</p>
          <p class="mb-2"><strong>Cu√°ndo usar:</strong> para separar ‚Äúver formulario‚Äù, ‚Äúenviar formulario‚Äù, ‚Äúborrar‚Äù, etc.</p>

          <div class="callout tip">
            <div class="title"><i class="fas fa-lightbulb me-2"></i>üí° En MVC, lo m√°s com√∫n</div>
            <div>
              <ul class="mb-0">
                <li><code>@GetMapping</code> para mostrar p√°ginas (lista, detalle, formulario)</li>
                <li><code>@PostMapping</code> para procesar formularios</li>
              </ul>
            </div>
          </div>

          <pre><code>@Controller
@RequestMapping("/productos") // prefijo com√∫n
public class ProductoMvcController {

  private final ProductoService service;

  public ProductoMvcController(ProductoService service) {
    this.service = service;
  }

  // GET /productos
  @GetMapping
  public String listar(Model model) {
    model.addAttribute("productos", service.listar());
    return "productos/lista";
  }

  // GET /productos/nuevo  (muestra formulario)
  @GetMapping("/nuevo")
  public String formularioNuevo(Model model) {
    model.addAttribute("productoForm", new ProductoForm());
    return "productos/form";
  }

  // POST /productos (procesa formulario)
  @PostMapping
  public String crear(
      @Valid @ModelAttribute("productoForm") ProductoForm form,
      BindingResult binding,
      RedirectAttributes redirect
  ) {
    if (binding.hasErrors()) {
      // si hay errores de validaci√≥n, vuelves al form
      return "productos/form";
    }

    Long id = service.crear(form);
    redirect.addFlashAttribute("msgOk", "Producto creado con √©xito");
    return "redirect:/productos/" + id;
  }

  // GET /productos/{id} (detalle)
  @GetMapping("/{id}")
  public String detalle(@PathVariable Long id, Model model) {
    ProductoDto p = service.obtenerPorId(id)
        .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND));

    model.addAttribute("producto", p);
    return "productos/detalle";
  }

  // POST /productos/{id}/borrar (forma MVC "cl√°sica")
  // Nota: los formularios HTML no env√≠an DELETE f√°cilmente (sin JS o filtros).
  @PostMapping("/{id}/borrar")
  public String borrar(@PathVariable Long id, RedirectAttributes redirect) {
    service.borrar(id);
    redirect.addFlashAttribute("msgOk", "Producto eliminado");
    return "redirect:/productos";
  }
}</code></pre>

          <div class="callout warn">
            <div class="title"><i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Sobre PUT/DELETE en HTML</div>
            <div>
              Los formularios HTML suelen enviar <strong>GET/POST</strong>. Para simular <code>PUT</code>/<code>DELETE</code>
              se usa JavaScript, o el mecanismo de Spring <em>HiddenHttpMethodFilter</em> (campo oculto <code>_method</code>).
              Para empezar, el patr√≥n <code>POST /{id}/borrar</code> es simple y did√°ctico.
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- 2) Par√°metros en MVC: @PathVariable, @RequestParam, @ModelAttribute -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingParams">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParams" aria-expanded="false" aria-controls="collapseParams">
          <i class="fas fa-sliders-h me-2"></i> Par√°metros en MVC: @PathVariable, @RequestParam, @ModelAttribute
        </button>
      </h2>

      <div id="collapseParams" class="accordion-collapse collapse" aria-labelledby="headingParams" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <p class="mb-2"><strong>Prop√≥sito:</strong> recoger datos de URL, query y formularios HTML.</p>

          <div class="callout good">
            <div class="title"><i class="fas fa-check-circle me-2"></i>‚úÖ Buenas pr√°cticas</div>
            <div>
              <ul class="mb-0">
                <li>IDs y rutas ‚Üí <code>@PathVariable</code></li>
                <li>Filtros/b√∫squeda ‚Üí <code>@RequestParam</code></li>
                <li>Formularios ‚Üí <code>@ModelAttribute</code> + <code>BindingResult</code></li>
              </ul>
            </div>
          </div>

          <pre><code>// GET /productos/buscar?q=teclado
@GetMapping("/buscar")
public String buscar(@RequestParam String q, Model model) {
  model.addAttribute("productos", service.buscar(q));
  model.addAttribute("q", q);
  return "productos/lista"; // reutilizas la vista de listado
}

// Formularios: el form se mapea a un objeto (ProductoForm)
public class ProductoForm {
  @NotBlank(message = "El nombre es obligatorio")
  private String nombre;

  @NotNull(message = "El precio es obligatorio")
  @Positive(message = "El precio debe ser positivo")
  private BigDecimal precio;

  // getters/setters
}

// Procesar env√≠o:
@PostMapping
public String crear(
  @Valid @ModelAttribute("productoForm") ProductoForm form,
  BindingResult binding,
  Model model
) {
  if (binding.hasErrors()) {
    // Aqu√≠ Thymeleaf puede mostrar errores con th:errors / #fields
    return "productos/form";
  }
  service.crear(form);
  return "redirect:/productos";
}</code></pre>

          <div class="callout tip">
            <div class="title"><i class="fas fa-lightbulb me-2"></i>üí° Pro-tip para Thymeleaf</div>
            <div>
              Si en la vista usas <code>&lt;form th:object="${productoForm}" ...&gt;</code>,
              los campos con <code>th:field</code> se enlazan autom√°ticamente al objeto del Model.
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- 3) Validaci√≥n + feedback en la vista -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingValidation">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseValidation" aria-expanded="false" aria-controls="collapseValidation">
          <i class="fas fa-shield-alt me-2"></i> Validaci√≥n en MVC: @Valid, BindingResult y mensajes en Thymeleaf
        </button>
      </h2>

      <div id="collapseValidation" class="accordion-collapse collapse" aria-labelledby="headingValidation" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <p class="mb-2"><strong>Prop√≥sito:</strong> evitar datos inv√°lidos y mostrar errores al usuario en el formulario.</p>

          <pre><code>// Controller (parte clave)
@PostMapping("/registro")
public String registrar(
  @Valid @ModelAttribute("userForm") UserForm form,
  BindingResult binding
) {
  if (binding.hasErrors()) {
    // Se queda en la misma vista mostrando errores
    return "usuarios/registro";
  }
  service.registrar(form);
  return "redirect:/login";
}</code></pre>

          <pre><code>&lt;!-- templates/usuarios/registro.html (ideas clave) --&gt;
&lt;form th:object="${userForm}" th:action="@{/registro}" method="post"&gt;

  &lt;div class="mb-3"&gt;
    &lt;label class="form-label"&gt;Email&lt;/label&gt;
    &lt;input class="form-control" th:field="*{email}" /&gt;

    &lt;!-- Mensaje de error asociado al campo --&gt;
    &lt;div class="text-danger" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"&gt;
      Error email
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;button class="btn btn-success"&gt;Enviar&lt;/button&gt;
&lt;/form&gt;</code></pre>

          <div class="callout warn">
            <div class="title"><i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Orden importante</div>
            <div>
              <code>BindingResult</code> debe ir <strong>justo despu√©s</strong> del objeto validado.
              Si no, Spring puede lanzar excepci√≥n en vez de devolverte el formulario con errores.
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- 4) Redirect y Flash Attributes -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingRedirect">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRedirect" aria-expanded="false" aria-controls="collapseRedirect">
          <i class="fas fa-exchange-alt me-2"></i> Post/Redirect/Get: redirect: y RedirectAttributes (mensajes)
        </button>
      </h2>

      <div id="collapseRedirect" class="accordion-collapse collapse" aria-labelledby="headingRedirect" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <p class="mb-2">
            <strong>Prop√≥sito:</strong> evitar reenv√≠os duplicados al refrescar (F5) tras un POST
            y mostrar mensajes de √©xito/aviso al usuario.
          </p>

          <div class="callout good">
            <div class="title"><i class="fas fa-check-circle me-2"></i>‚úÖ Patr√≥n Post/Redirect/Get</div>
            <div class="text-muted">
              Tras guardar con POST, haces <code>return "redirect:/ruta"</code>. As√≠ el navegador termina en GET.
            </div>
          </div>

          <pre><code>// POST /productos ‚Üí crea y redirige
@PostMapping("/productos")
public String crear(@Valid @ModelAttribute("productoForm") ProductoForm form,
                    BindingResult binding,
                    RedirectAttributes redirect) {
  if (binding.hasErrors()) return "productos/form";

  Long id = service.crear(form);

  // Mensaje flash: vive solo durante el redirect
  redirect.addFlashAttribute("msgOk", "Creado correctamente");
  return "redirect:/productos/" + id;
}</code></pre>

          <pre><code>&lt;!-- En la vista destino (p.e. templates/productos/detalle.html) --&gt;
&lt;div class="alert alert-success" th:if="${msgOk}" th:text="${msgOk}"&gt;OK&lt;/div&gt;</code></pre>

        </div>
      </div>
    </div>

    <!-- 5) Errores y 404 en MVC -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingErrors">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseErrors" aria-expanded="false" aria-controls="collapseErrors">
          <i class="fas fa-bug me-2"></i> Manejo de errores en MVC: ResponseStatusException y p√°ginas de error
        </button>
      </h2>

      <div id="collapseErrors" class="accordion-collapse collapse" aria-labelledby="headingErrors" data-bs-parent="#thymeleafAccordion">
        <div class="accordion-body">

          <p class="mb-2">
            <strong>Prop√≥sito:</strong> cuando algo no existe o falla, mostrar una p√°gina coherente (404, 500‚Ä¶).
          </p>

          <pre><code>// Si no existe el recurso: lanza 404
@GetMapping("/productos/{id}")
public String detalle(@PathVariable Long id, Model model) {
  ProductoDto p = service.obtenerPorId(id)
      .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, "Producto no existe"));

  model.addAttribute("producto", p);
  return "productos/detalle";
}</code></pre>

          <div class="callout tip">
            <div class="title"><i class="fas fa-lightbulb me-2"></i>üí° P√°gina 404 personalizada</div>
            <div>
              Si creas <code>templates/error/404.html</code>, Spring puede renderizar una vista propia para 404.
              (Tambi√©n existe la carpeta <code>resources/static/error</code> seg√∫n configuraci√≥n).
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <img src="i18n.png" alt="internaciolanizacion" class="img-fluid mt-4 rounded">

</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>
